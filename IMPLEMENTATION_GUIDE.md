# Vibe Infrastructure: Руководство по реализации

**Версия 1.0** | **Сопровождает OVERVIEW.md**

Этот документ предоставляет технические спецификации, необходимые для реализации системы Vibe Infrastructure. ИИ-ассистент, читающий этот документ, должен быть способен настроить начальную систему и задать соответствующие вопросы для завершения реализации.

## Предварительные требования

### Необходимые возможности

ИИ-ассистент должен иметь:
- Доступ на чтение/запись файлов
- Выполнение команд (локальное и удалённое SSH)
- Сетевой доступ (HTTP, SSH)
- Контроль версий (Git) для истории (рекомендуется)

### Требования к пользователю

Пользователь должен иметь:
- Доступ SSH к сетевым устройствам (если ИИ будет управлять ими)
- Базовое понимание своей сетевой инфраструктуры
- ИИ-ассистент с возможностями, перечисленными выше

## Структура директорий

Создайте следующую структуру директорий. Эта структура обязательна — ИИ ожидает эти пути:

```
HomeNetwork/
├── docs/
│   ├── network/          # Топология сети, VLAN, маршрутизация (ДИРЕКТОРИЯ)
│   │   ├── topology.md   # Файл топологии сети (НЕ docs/topology.md)
│   │   └── configs/      # Резервные копии файлов конфигурации (ДИРЕКТОРИЯ)
│   ├── devices/          # Директория физических устройств (содержит файлы {device}.md)
│   ├── servers/          # Директория серверов (содержит файлы {server}.md, НЕ docs/servers.md)
│   └── services/         # Директория сервисов (содержит файлы {service}.md, НЕ docs/services.md)
├── inventory/            # Структурированные данные (YAML файлы) (ДИРЕКТОРИЯ)
│   ├── devices.yaml      # Инвентарь устройств
│   ├── servers.yaml      # Инвентарь серверов
│   └── services.yaml     # Инвентарь сервисов (НЕ ip_allocation.yaml)
├── scripts/              # Скрипты автоматизации (ДИРЕКТОРИЯ)
├── diagnostics/          # Заметки по устранению неполадок (создаётся по необходимости) (ДИРЕКТОРИЯ)
└── .cursor/              # Конфигурация ИИ (если используется Cursor) (ДИРЕКТОРИЯ)
    └── rules/            # Протоколы команды ИИ (ДИРЕКТОРИЯ)
```

**Важные замечания по структуре:**
- Файлы протоколов (`networkguide.mdc`, `networkteam.mdc`) должны быть **скопированы из репозитория**, а не созданы с нуля
- `docs/devices/`, `docs/servers/` и `docs/services/` — это **директории**, содержащие отдельные markdown файлы (например, `docs/devices/router.md`, `docs/servers/nas.md`)
- `docs/network/` — это **директория**, содержащая `topology.md` (файл должен быть в `docs/network/topology.md`, НЕ `docs/topology.md` в корне)
- `docs/network/configs/` — это **обязательная поддиректория** для хранения резервных копий конфигураций
- `inventory/` содержит три YAML файла: `devices.yaml`, `servers.yaml` и `services.yaml` (НЕ `ip_allocation.yaml`)
- Все директории, включая `diagnostics/`, должны быть созданы при первоначальной настройке

**Примечание**: IP-адреса, показанные в примерах по всему этому руководству (например, 192.168.1.1, 192.168.1.200), являются значениями-заполнителями из стандартного диапазона частных IP. Замените их на вашу фактическую сетевую конфигурацию.


## Определение протокола команды ИИ

ИИ должен быть настроен с протоколом команды, который определяет роли, рабочие процессы и стандарты. Этот протокол должен быть настроен как правила: храниться в `.cursor/rules/networkguide.mdc` (для Cursor) или в соответствующей директории правил для других ИИ-ассистентов (проверьте документацию вашего ИИ-ассистента для точного расположения).

### Полные файлы протоколов

Полный протокол команды ИИ определён в двух файлах:

1. **networkguide.mdc** - Руководящие принципы взаимодействия, протоколы документации, стандарты проверки, процедуры устранения неполадок
2. **networkteam.mdc** - Структура команды, роли экспертов, рабочие процессы координации, определения SLA

Эти файлы содержат подробные правила, которые управляют работой ИИ. Они должны быть:
- Размещены в `.cursor/rules/` (для Cursor IDE)
- Настроены как правила в соответствующей директории правил для других ИИ-ассистентов (проверьте документацию вашего ИИ-ассистента для точного расположения)
- Рассматриваться как "руководство по эксплуатации" для команды ИИ

**Примечание**: Эти файлы протоколов обширны (2000+ строк вместе) и определяют каждый аспект поведения команды. Спецификации в этом Руководстве по реализации суммируют ключевые требования, но полные протоколы предоставляют подробные детали, включая:
- Подробные деревья решений для устранения неполадок
- Общие ошибки и стратегии предотвращения
- Шаблоны сводок сеансов
- Протоколы экстренного реагирования
- Процессы обучения и улучшения

**Получение протоколов**:

**Вариант 1 - Этот репозиторий**: Полные файлы протоколов включены в этот репозиторий. **Скопируйте** (не создавайте) `networkguide.mdc` и `networkteam.mdc` из корневой директории репозитория в вашу директорию `.cursor/rules/` (для Cursor IDE) или настройте их как правила в соответствующей директории правил для других ИИ-ассистентов (проверьте документацию вашего ИИ-ассистента для точного расположения). Эти файлы уже существуют в репозитории и должны быть скопированы, а не созданы с нуля.

**Вариант 2 - Создайте свои собственные**: Используйте спецификации в этом Руководстве по реализации для создания ваших собственных файлов протоколов. Ключевые разделы задокументированы выше (Структура команды, Основной рабочий процесс, Стандарты документации и т.д.), и вы можете настроить их для ваших конкретных потребностей.

Для Cursor IDE файлы протоколов должны быть размещены в директории `.cursor/rules/`. Для других ИИ-ассистентов они должны быть настроены как правила (не как знания проекта или общий контекст).

### Необходимые компоненты протокола

#### 1. Структура команды

Определите специализированные роли экспертов:
- **Service Delivery Manager**: Координирует всю работу, оценивает приоритеты, обеспечивает качество
- **Senior Network Engineer**: Маршрутизация, коммутация, VLAN, Wi-Fi
- **Senior DevOps Engineer**: Docker, контейнеры, оркестрация
- **Storage Systems Administrator**: NAS, хранилище, резервные копии
- **Network Security Engineer**: Файрволы, контроль доступа, безопасность
- **IoT & Automation Engineer**: Устройства умного дома, автоматизация
- **Backup & Recovery Specialist**: Стратегии резервного копирования, процедуры восстановления
- **Technical Documentation Specialist**: Поддержка документации

Команда координируется внутренне. Пользователи видят результаты, а не координацию.

#### 2. Основной рабочий процесс

Для каждого запроса пользователя ИИ должен следовать:
1. **Проверить**: Проверить фактическое состояние (например, `docker ps`, `ping`) перед предположениями
2. **Исследовать**: Прочитать существующие файлы в `docs/` и `inventory/`
3. **Планировать**: Решить об исправлении или изменении, оценить влияние
4. **Выполнить**: Предоставить команды или выполнить редактирование
5. **Задокументировать**: Обновить соответствующие файлы `.md` в `docs/`, чтобы отразить новое состояние

#### 3. Стандарты документации

ИИ отвечает за поддержку "Единственного источника истины" в папке `docs/`:
- **Топология**: Поддерживать `docs/network/topology.md` обновлённым
- **Устройства**: Создавать/обновлять `docs/devices/{device}.md`
- **Серверы**: Создавать/обновлять `docs/servers/{server}.md`
- **Сервисы**: Создавать/обновлять `docs/services/{service}.md`
- **Инвентарь**: Поддерживать YAML файлы в `inventory/`

#### 4. Соглашения об уровне обслуживания (Приоритеты)

Оценивайте срочность внутренне:
- **CRITICAL**: Сбой сети, нарушение безопасности, риск потери данных (немедленные действия)
- **URGENT**: Основной сервис не работает, влияет на нескольких пользователей/сервисы (в течение 1 часа)
- **HIGH**: Сервис деградирован, влияние на одного пользователя (в течение 4 часов)
- **MEDIUM**: Изменения конфигурации, несрочные обновления (в течение 24 часов)
- **LOW**: Обновления документации, оптимизация (по возможности)

#### 5. Управление изменениями

Все изменения требуют:
- Просмотра документации перед началом
- Проверки резервной копии (проверить существующую или создать новую)
- Оценки влияния (какие сервисы/устройства затронуты)
- Определения плана отката
- Шагов проверки после изменения
- Обновлений документации после завершения

Крупные изменения дополнительно требуют:
- Уведомления пользователя о потенциальном влиянии
- Расширенного периода проверки
- Чётких задокументированных процедур отката

#### 6. Требования к проверке

ИИ никогда не должен предполагать. Всегда проверять:
- Имена контейнеров: `docker ps --format "{{.Names}}"`
- Пользователей SSH: Проверить документацию, затем проверить с `whoami`
- Статус сервиса: Проверить реальность перед устранением неполадок
- Расположение файлов: Проверить с `find` или проверить документацию
- Конфигурацию сети: Сравнить фактическое состояние с задокументированным

#### 7. Стиль общения

- Профессиональный, но разговорный
- Ориентированный на действия: "Я проверил X, нашёл Y, исправил это, сделав Z"
- Всегда показывать проверку: "✓ Сервис отвечает"
- Без объяснения внутренних процессов: Не перечислять, какие эксперты были проконсультированы

## Процесс первоначальной настройки

При настройке новой системы Vibe Infrastructure ИИ должен:

1. **Скопировать файлы протоколов из репозитория** (НЕ создавайте новые файлы - они уже существуют в репозитории):
   - Скопировать `networkguide.mdc` из корня репозитория в `.cursor/rules/networkguide.mdc` (или эквивалентную директорию правил)
   - Скопировать `networkteam.mdc` из корня репозитория в `.cursor/rules/networkteam.mdc` (или эквивалентную директорию правил)
   - Эти файлы определяют поведение ИИ и должны быть скопированы из репозитория, а не созданы с нуля

2. **Создать структуру директорий** (точно как указано выше - создать ВСЕ директории):
   - `docs/` (корневая директория документации)
   - `docs/network/` (директория для топологии сети и конфигурации)
   - `docs/network/configs/` (поддиректория для резервных копий конфигураций - ОБЯЗАТЕЛЬНО)
   - `docs/devices/` (директория для отдельных файлов устройств)
   - `docs/servers/` (директория для отдельных файлов серверов)
   - `docs/services/` (директория для отдельных файлов сервисов)
   - `inventory/` (для YAML файлов инвентаря)
   - `scripts/` (для скриптов автоматизации)
   - `diagnostics/` (для заметок по устранению неполадок - создать при первоначальной настройке)
   - `.cursor/rules/` (для файлов протоколов ИИ)

3. **Создать начальные шаблонные файлы** (использовать точные пути, указанные выше):
   - `docs/network/topology.md` (базовый шаблон - ДОЛЖЕН быть в директории `docs/network/`, НЕ `docs/topology.md` в корне)
   - `inventory/devices.yaml` (шаблон структуры YAML)
   - `inventory/servers.yaml` (шаблон структуры YAML)
   - `inventory/services.yaml` (шаблон структуры YAML - НЕ `ip_allocation.yaml`)
   - **Важно**: НЕ создавайте `docs/servers.md` или `docs/services.md` как отдельные файлы - это директории, содержащие отдельные файлы `{name}.md` (например, `docs/servers/nas.md`, `docs/services/plex.md`)

4. **Спросить у пользователя начальную информацию**:
   - Модель роутера и IP-адрес
   - Метод доступа (пользователь SSH, URL веб-интерфейса)
   - Любая существующая сетевая документация
   - Ключевые устройства или сервисы для документирования в первую очередь

## Форматы файлов документации

### Документация устройства (`docs/devices/{device}.md`)

Обязательные разделы:
- Основная информация (тип, модель, расположение, назначение)
- Сетевая конфигурация (IP-адреса, интерфейсы, VLAN)
- Аутентификация (методы доступа, расположение учётных данных)
- Сервисы/Функции (что предоставляет устройство)
- Детали конфигурации (важные настройки, пользовательские конфигурации)
- Устранение неполадок (общие проблемы и решения)
- Временная метка последнего обновления

**Пример шаблона**:

```markdown
# EdgeRouter X

## Основная информация
- **Тип**: Роутер
- **Модель**: EdgeRouter X 5-Port
- **Расположение**: Сетевой шкаф
- **Назначение**: Основной роутер и файрвол

## Сетевая конфигурация
- **WAN Интерфейс**: eth0 (DHCP от провайдера)
- **LAN Интерфейс**: switch0 (192.168.1.1/24)
- **Управление**: 192.168.1.1

## Аутентификация
- **SSH**: `ssh admin@192.168.1.1`
- **Веб-интерфейс**: https://192.168.1.1
- **Учётные данные**: Хранятся в менеджере паролей

## Сервисы/Функции
- NAT
- DHCP сервер (192.168.1.100-192.168.1.200)
- DNS Forwarding
- Файрвол

## Детали конфигурации
- DHCP включён на switch0
- NAT masquerading на eth0
- Аппаратное ускорение включено

## Устранение неполадок
(Будет заполнено по мере возникновения проблем)

**Последнее обновление**: 2025-01-19
```

### Документация сервера (`docs/servers/{server}.md`)

Обязательные разделы:
- Основная информация (тип, модель, расположение, ОС)
- Сетевая конфигурация (IP-адреса, интерфейсы)
- Аутентификация (пользователь SSH, методы доступа)
- Запущенные сервисы (какие сервисы размещены)
- Конфигурация хранилища (если применимо)
- Настройка Docker/Контейнеров (если применимо)
- Информация о резервном копировании
- Временная метка последнего обновления

**Пример шаблона**:

```markdown
# QNAP NAS

## Основная информация
- **Тип**: NAS
- **Модель**: QNAP TS-451
- **Расположение**: Сетевой шкаф
- **Операционная система**: QTS 5.2.4

## Сетевая конфигурация
- **Основной IP**: 192.168.1.200
- **Имя хоста**: NAS
- **Интерфейсы**: eth0 (основной), eth1 (вторичный)

## Аутентификация
- **SSH**: `ssh admin@192.168.1.200`
- **Веб-интерфейс**: https://192.168.1.200
- **Учётные данные**: Хранятся в менеджере паролей

## Запущенные сервисы
- Общий доступ к файлам SMB/CIFS
- Общий доступ к файлам NFS
- WireGuard VPN сервер
- Transmission (торрент-клиент)

## Конфигурация хранилища
- **Общее хранилище**: 16TB
- **Использовано**: 8.3TB
- **Доступно**: 7.6TB
- **RAID**: RAID 5

## Настройка Docker/Контейнеров
- Docker доступен через Container Station
- Контейнеры используют сеть bridge по умолчанию

## Информация о резервном копировании
- Резервные копии конфигурации: `backups/nas_configs_raw_YYYY-MM-DD.zip`
- Расписание автоматического резервного копирования: Еженедельно

**Последнее обновление**: 2025-01-19
```

### Документация сервиса (`docs/services/{service}.md`)

Обязательные разделы:
- Описание
- Сетевая конфигурация (IP, порты, домены)
- Расположение файла Docker Compose (если контейнеризован)
- Пути постоянных данных
- Особые примечания (GPU, специальные конфигурации, зависимости)
- Устранение неполадок (общие проблемы и решения)
- Временная метка последнего обновления

**Пример шаблона**:

```markdown
# Plex Media Server

## Описание
Сервер потоковой передачи медиа для видео, музыки и фотографий.

## Сетевая конфигурация
- **IP-адрес**: 192.168.1.50 (macvlan)
- **Порт**: 32400
- **Домен**: plex.example.com (через обратный прокси)

## Расположение файла Docker Compose
- `~/dockers/plex/docker-compose.yml`

## Пути постоянных данных
- **Конфигурация**: `/srv/docker-data/plex/config` → `/config`
- **Кэш транскодирования**: `/srv/docker-data/plex/transcode` → `/transcode`
- **Медиа-библиотека**: `/mnt/nas/videos` → `/videos`

## Особые примечания
- Транскодирование GPU включено (NVIDIA RTX 3060)
- Доступ к USB-устройствам настроен для предотвращения ошибок libusb_init

## Устранение неполадок
### Контейнер завершается с ошибкой "libusb_init failed"
**Симптом**: Контейнер останавливается сразу с ошибкой "Critical: libusb_init failed"
**Решение**: Убедитесь, что доступ к USB-устройствам настроен в docker-compose.yml:
```yaml
devices:
  - /dev/bus/usb:/dev/bus/usb
```

**Последнее обновление**: 2025-01-29
```

### Топология сети (`docs/network/topology.md`)

Обязательные разделы:
- Основные устройства и соединения (формат таблицы)
- Логические сети и VLAN
- Схема IP-адресации
- Точки беспроводного доступа (если применимо)
- SSID и маппинг VLAN (если применимо)

## Структура YAML инвентаря

### `inventory/devices.yaml`

```yaml
---
metadata:
  last_updated: "YYYY-MM-DD"
  version: 1
  
devices:
  - name: "DeviceName"
    type: "Router|Switch|AP|etc"
    model: "Model Name"
    manufacturer: "Manufacturer"
    ip_address: "192.168.1.1"
    mac_address: "AA:BB:CC:DD:EE:FF"
    hostname: "hostname"
    location: "Physical location"
    documentation: "../docs/devices/devicename.md"
    services:
      - "Service 1"
      - "Service 2"
```

### `inventory/servers.yaml`

```yaml
---
metadata:
  last_updated: "YYYY-MM-DD"
  version: 1
  
servers:
  - name: "ServerName"
    type: "NAS|Server|VM"
    model: "Model Name"
    ip_address: "192.168.1.200"
    hostname: "hostname"
    location: "Physical location"
    documentation: "../docs/servers/servername.md"
    operating_system: "OS Version"
    services:
      - "Service 1"
      - "Service 2"
```

### `inventory/services.yaml`

```yaml
---
metadata:
  last_updated: "YYYY-MM-DD"
  version: 1
  
services:
  - name: "ServiceName"
    type: "Docker|Native|QPKG"
    host: "ServerName"
    url: "http://192.168.1.50:port"
    port: 32400
    documentation: "../docs/services/servicename.md"
    description: "What the service does"
```

## Команды проверки

ИИ должен использовать эти команды для проверки фактического состояния:

### Проверка контейнера
```bash
docker ps --format "{{.Names}}\t{{.Status}}\t{{.Ports}}"
docker ps -a --filter "name=<container_name>"
docker logs --tail 50 <container_name>
docker inspect <container_name> | grep -A 5 IPAddress
```

### Статус сервиса
```bash
systemctl status <service_name>
curl -f http://<service_ip>:<port>
ping <device_ip>
```

### Доступ SSH
```bash
ssh user@host "whoami"
ssh user@host "pwd"
```

### Расположение файлов
```bash
find ~/dockers -name "docker-compose.yml" -type f
find /opt -name "docker-compose.yml" -type f
```

## Общие паттерны

### Паттерн устранения неполадок

Когда пользователь сообщает о проблеме:
1. Проверить документацию для затронутого сервиса/устройства
2. Проверить фактическое состояние (статус контейнера, статус сервиса, связность)
3. Просмотреть недавние изменения в документации
4. Проверить похожие прошлые проблемы в разделах устранения неполадок
5. Диагностировать на основе фактического состояния vs. задокументированного состояния
6. Исправить проблему
7. Проверить исправление
8. Задокументировать решение

### Паттерн обновления документации

При внесении изменений:
1. Определить все файлы, которые нужно обновить (устройство, сервер, сервис, топология, инвентарь)
2. Создать резервную копию при необходимости
3. Внести изменение
4. Проверить изменение
5. Обновить все соответствующие файлы документации
6. Обновить инвентарь, если изменились IP, роли или детали

### Паттерн обучения

При возникновении проблем:
- **1-е появление**: Задокументировать в заметках сервиса с датой
- **2-е появление**: Добавить в раздел устранения неполадок
- **3-е появление**: Добавить в паттерны быстрой диагностики в протоколе

## Устранение неполадок системы Vibe Infrastructure

Если ИИ ведёт себя неожиданно:

### ИИ не следует протоколам
- **Проверить**: Правильно ли настроены файлы протоколов как правила?
- **Проверить**: В Cursor проверьте, что `.cursor/rules/` существует и содержит `networkguide.mdc` и `networkteam.mdc`
- **Проверить**: Для других ИИ-ассистентов проверьте, что файлы находятся в директории правил (не в знаниях проекта)
- **Тест**: Спросите ИИ "Какие у тебя основные шаги рабочего процесса?" - он должен ответить: Проверить → Исследовать → Планировать → Выполнить → Задокументировать

### Документация не обновляется
- **Проверить**: Есть ли у ИИ доступ на запись в директорию `docs/`?
- **Проверить**: Git status показывает незакоммиченные изменения после обновлений ИИ
- **Исправить**: Убедитесь, что права на файлы разрешают запись

### ИИ не проверяет фактическое состояние
- **Проверить**: Есть ли у ИИ возможности выполнения команд?
- **Тест**: Спросите ИИ "Какие контейнеры работают?" - он должен выполнить `docker ps`, а не угадывать
- **Исправить**: Включите выполнение команд в настройках ИИ-ассистента

### ИИ предполагает вместо проверки
- **Напомнить**: Включите в ваш запрос "Сначала проверь фактическое состояние"
- **Обновление протокола**: Добавьте акцент на требования к проверке в протоколе
- **Проверить**: Просмотрите, доступны ли команды проверки для ИИ

### Неправильная структура документации
- **Проверить**: Структура директорий точно соответствует спецификации
- **Проверить**: Пути в YAML файлах инвентаря правильны
- **Исправить**: Пересоздайте структуру директорий при необходимости

## Точки настройки

Система может быть настроена путём изменения:

1. **Роли команды**: Добавлять или удалять роли экспертов на основе инфраструктуры
2. **Определения приоритетов**: Настраивать приоритеты SLA в соответствии с потребностями пользователя
3. **Структура документации**: Изменять организацию файлов при необходимости
4. **Команды проверки**: Добавлять шаги проверки для конкретной области
5. **Шаги рабочего процесса**: Настраивать основной рабочий процесс при предпочтении

## Вопросы для первоначальной настройки

При настройке новой системы ИИ должен спросить:

1. **Информация о роутере**:
   - Какая у вас модель роутера?
   - Какой IP-адрес роутера?
   - Как вы получаете к нему доступ? (пользователь SSH, URL веб-интерфейса)
   - Настроены ли у вас SSH-ключи?

2. **Структура сети**:
   - Какой у вас основной диапазон IP сети? (например, 192.168.1.0/24)
   - Используете ли вы VLAN? Если да, какие VLAN и их назначение?
   - Какие устройства в вашей сети?

3. **Серверы**:
   - Есть ли у вас NAS или домашний сервер?
   - Какие сервисы работают? (Plex, Home Assistant и т.д.)
   - Контейнеризованы ли сервисы? (Docker)

4. **Методы доступа**:
   - Можете ли вы SSH к вашим устройствам?
   - Настроены ли у вас SSH-ключи?
   - Есть ли устройства, требующие специальных методов доступа?

5. **Существующая документация**:
   - Есть ли у вас какая-либо существующая сетевая документация?
   - Есть ли резервные копии конфигураций, о которых мне следует знать?

## Чеклист реализации

При реализации убедитесь:

- [ ] Структура директорий создана
- [ ] Протокол команды ИИ настроен
- [ ] Начальные шаблонные файлы созданы
- [ ] Роутер задокументирован (первое устройство)
- [ ] Топология сети начата
- [ ] Файлы инвентаря инициализированы
- [ ] Пользователь понимает, что система готова к первой задаче

Система строится сама со временем. Начните с основ — ИИ добавит детали по мере совместной работы.

## После первоначальной настройки: Первые задачи

После завершения первоначальной настройки начните с простых задач документирования:

### Хорошие первые задачи
- "Задокументируй мой NAS по адресу 192.168.1.200"
- "Проверь, все ли сервисы работают"
- "Обнови топологию сети моим коммутатором"
- "Добавь документацию для моего Plex сервера"

### Избегать как первых задач
- Сложные миграции или реконфигурации
- Экстренное устранение неполадок
- Крупномасштабные изменения инфраструктуры

**Почему**: Первые задачи строят основу документации. Система становится более эффективной по мере изучения вашей инфраструктуры через эти начальные задачи документирования.

### Переход к операционному использованию

После документирования 3-5 устройств/сервисов система готова к:
- Устранению неполадок
- Внесению изменений конфигурации
- Обновлению сервисов
- Сложным задачам, требующим контекста

Чем больше задокументировано, тем более способной становится система.
